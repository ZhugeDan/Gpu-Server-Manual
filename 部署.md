------

# ğŸ“˜ æ·±åº¦å­¦ä¹  GPU æœåŠ¡å™¨å…¨æµç¨‹æ­å»ºæ‰‹å†Œ (LXDç‰ˆ)

é€‚ç”¨ç¯å¢ƒï¼š Tyan Server / 3x RTX 3090 / Ubuntu 22.04 LTS

æ¶æ„æ ¸å¿ƒï¼š å®¿ä¸»æœº (Host) è´Ÿè´£é©±åŠ¨ç¡¬ä»¶ + LXD å®¹å™¨ (Container) è´Ÿè´£éš”ç¦»ç¯å¢ƒ 

å…·ä½“å®ç°ï¼š **Ubuntu 24.04 + LXD (Snapç‰ˆ) + NVIDIA 535é©±åŠ¨**

æ–‡æ¡£ç»´æŠ¤è€…ï¼š å®éªŒå®¤ç®¡ç†å‘˜

------

## ğŸ› ï¸ ç¬¬ä¸€é˜¶æ®µï¼šç‰©ç†å‡†å¤‡ä¸ç³»ç»Ÿå®‰è£… (Day 0)

### 1. åˆ¶ä½œå¯åŠ¨ç›˜

- **å·¥å…·ï¼š** [Rufus](https://rufus.ie/) (Windows) 
- **é•œåƒï¼š** Ubuntu Server 22.04 LTS ISOã€‚
- **æ“ä½œï¼š** æ’å…¥ U ç›˜ï¼Œé€‰æ‹© ISOï¼Œç‚¹å‡»â€œå¼€å§‹â€ã€‚

### 2. ç‰©ç†è¿çº¿ 

- **ç½‘çº¿ä½ç½®ï¼š** åŠ¡å¿…é¿å¼€æ ‡æœ‰ **IPMI** æˆ– **BMC** çš„ä¸“ç”¨ç®¡ç†å£ã€‚è¯·æ’å…¥æ™®é€šçš„åƒå…†/ä¸‡å…†ç½‘å£ï¼ˆé€šå¸¸æ˜¾ç¤ºä¸º `eno1`, `eth0` ç­‰ï¼‰ã€‚
- å‰æœŸæµ‹è¯•é˜¶æ®µï¼š
- **æ˜¾ç¤ºè¾“å‡ºï¼š** å¦‚æœæ’äº†ç‹¬æ˜¾ï¼Œæ˜¾ç¤ºå™¨çº¿å¯èƒ½éœ€è¦æ’åœ¨**ç‹¬æ˜¾**ä¸Šæ‰èƒ½çœ‹åˆ°å®‰è£…ç•Œé¢ï¼ˆè§†ä¸»æ¿è®¾ç½®è€Œå®šï¼‰ã€‚
- æˆ‘ä»¬æœåŠ¡å™¨åº”è¯¥æ¥çš„ç½‘å£ï¼š![image-20251213212956715](../obsidian/photo/image-20251213212956715.png)

### 3. å®‰è£… Ubuntu Serverï¼ˆ[æ¨èè§†é¢‘](https://www.bilibili.com/video/BV1Bs4y1X7mH/?spm_id_from=333.337.search-card.all.click&vd_source=eee2b19a6c821bc098b68b1968932c4c)ï¼‰

- **åˆ†åŒºï¼š** é»˜è®¤ä½¿ç”¨ LVM å³å¯ã€‚
- **SSH Serverï¼š** å®‰è£…å‘å¯¼ä¸­åŠ¡å¿…å‹¾é€‰ **[x] Install OpenSSH server**ã€‚
- **å…¶ä»–è½¯ä»¶ï¼š** Docker, Kubernetes ç­‰**ä¸€å¾‹ä¸é€‰**ï¼ˆä¿æŒç³»ç»Ÿçº¯å‡€ï¼‰ã€‚

------

## ğŸ—ï¸ ç¬¬äºŒé˜¶æ®µï¼šå®¿ä¸»æœº (Host) ç¯å¢ƒé…ç½®

ç³»ç»Ÿè£…å¥½åï¼Œé¦–å…ˆé…ç½®å®¿ä¸»çš„ç¯å¢ƒã€‚

### 1. æ¢æºä¸æ›´æ–° (è§£å†³ä¸‹è½½æ…¢)

Bash

```
# å¤‡ä»½
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
# æ›¿æ¢ä¸ºæ¸…åæº/é˜¿é‡Œæº (å»ºè®®ç”¨ vim ç¼–è¾‘æˆ–ç”¨ sed å‘½ä»¤æ›¿æ¢)
sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
sudo sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
# æ›´æ–°
sudo apt update && sudo apt upgrade -y
```

### 2. å®‰è£…æ˜¾å¡é©±åŠ¨

**åŸåˆ™ï¼š** å®¿ä¸»æœºåªè£… é©±åŠ¨ï¼ˆDriverï¼‰ï¼Œä¸è£… CUDA Toolkitã€‚**cuda<=12.2**çš„ç‰ˆæœ¬éƒ½èƒ½æ”¯æŒï¼Œæ›´é«˜ä¸è¡Œï¼Œè‹¥è¿™æ ·éœ€è¦åœ¨å®¿ä¸»ä¸Šæ¢é©±åŠ¨

Bash

```
# 1. å®‰è£…æœåŠ¡å™¨ç‰ˆé©±åŠ¨ (Headlessï¼Œä¸å¸¦å›¾å½¢ç•Œé¢ï¼Œæ›´ç¨³å®š)
sudo apt install nvidia-driver-535-server nvidia-utils-535-server

# 2. é‡å¯ç”Ÿæ•ˆ
sudo reboot
```

*éªŒè¯ï¼š* é‡å¯åè¾“å…¥ `nvidia-smi`ï¼Œå¿…é¡»çœ‹åˆ°æ˜¾å¡åˆ—è¡¨ã€‚

### 3. åˆå§‹åŒ– LXD è™šæ‹ŸåŒ–å¼•æ“

Bash

```
sudo lxd init
```

- **æ“ä½œç­–ç•¥ï¼š** ä¸€è·¯å›è½¦ï¼ˆDefaultï¼‰å³å¯ã€‚ç¡®ä¿ç½‘ç»œéƒ¨åˆ†åˆ›å»ºäº† `lxdbr0` ç½‘æ¡¥ã€‚
- ![image-20251213213644207](../obsidian/photo/image-20251213213644207.png)

### 4. åˆ›å»ºå…¬å…±æ•°æ®é›†ä»“åº“ (æ–°å¢ç»éªŒ)

ä¸ºäº†é¿å…é‡å¤ä¸‹è½½æ•°æ®é›†ï¼Œå ç”¨ç¡¬ç›˜ç©ºé—´ï¼Œåœ¨å®¿ä¸»æœºå»ºç«‹å…±äº«æ± ã€‚

Bash

```
mkdir -p /home/ubuntu/shared_datasets
# å°†ä¸‹è½½å¥½çš„æ•°æ®é›† zip åŒ…è§£å‹æ”¾è¿›å»
```

------

## ğŸ§¬ ç¬¬ä¸‰é˜¶æ®µï¼šåˆ¶ä½œå®¹å™¨æ¨¡æ¿

### 1. å¯åŠ¨è£…ä¿®å®¹å™¨

Bash

```
# ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå¯åŠ¨
lxc launch images:ubuntu/22.04 template-builder
# æ˜ å°„æ˜¾å¡ (ä¸ºäº†å®‰è£… utils)
lxc config device add template-builder gpu gpu
# è¿›å…¥å®¹å™¨
lxc exec template-builder bash
```

### 2. å®¹å™¨å†…â€œäº”å¤§è¡¥ä¸â€ (åœ¨ `root@template-builder` ä¸‹æ‰§è¡Œ)

#### ğŸ› ï¸ è¡¥ä¸ 1ï¼šç³»ç»ŸåŸºç¡€ä¸ APT æ¢æº

Bash

```
sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
apt update && apt install -y git vim wget curl build-essential unzip htop
```

#### ğŸ› ï¸ è¡¥ä¸ 2ï¼šæ˜¾å¡è¯†åˆ«å·¥å…· 

- **æ“ä½œï¼š** åªè£… `utils`ï¼Œ**ç»ä¸è£…** `driver`ã€‚

Bash

```
apt install -y nvidia-utils-535-server
```

#### ğŸ› ï¸ è¡¥ä¸ 3ï¼šä¿®å¤ SSH ç™»å½• (è§£å†³ Permission denied)

- **ç—›ç‚¹å›é¡¾ï¼š** é»˜è®¤é…ç½®ç¦æ­¢å¯†ç ç™»å½•ï¼Œå¯¼è‡´ SSH è¿ä¸ä¸Šã€‚

Bash

```
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
# è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è¦†ç›– cloud-init çš„é»˜è®¤é…ç½®
sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config.d/*.conf
service ssh restart
```

#### ğŸ› ï¸ è¡¥ä¸ 4ï¼šå®‰è£… Miniconda å¹¶ä¿®å¤ ToS æŠ¥é”™

- è¿™é‡Œé€‰ç”¨çš„æ›´ç²¾ç®€çš„minicondaã€‚**å¦‚æœä¸é€‚ç”¨æ€ä¹ˆåŠï¼Ÿ**åˆ›å»ºä¸€ä¸ªè‡ªå·±é€‚ç”¨çš„annacondaçš„æ¨¡æ¿ã€‚

Bash

```
# 1. å®‰è£… Miniconda
wget https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda

# 2. é…ç½®ç¯å¢ƒå˜é‡
echo 'export PATH="/opt/miniconda/bin:$PATH"' >> /etc/bash.bashrc
source /etc/bash.bashrc
conda init bash

# 3. æ³¨å…¥ Conda é…ç½®æ–‡ä»¶ (å½»åº•ç»•è¿‡ ToS æŠ¥é”™)
cat <<EOF > /opt/miniconda/.condarc
channels:
  - defaults
show_channel_urls: true
default_channels:
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
EOF
```

#### ğŸ› ï¸ è¡¥ä¸ 5ï¼šPip å…¨å±€åŠ é€Ÿ

Bash

```
mkdir -p /etc/pip.conf
cat <<EOF > /etc/pip.conf
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF
```

### 3. å°å­˜é•œåƒ

Bash

```
exit # é€€å‡ºå®¹å™¨
lxc stop template-builder
lxc publish template-builder --alias founding-titan-v2
lxc delete template-builder # åˆ é™¤è£…ä¿®å·¥
```

------

## ğŸš€ ç¬¬å››é˜¶æ®µï¼šç”¨æˆ·å¼€æˆ·æ ‡å‡†æµç¨‹ (SOP)

æ¯å½“æœ‰æ–°åŒå­¦ï¼ˆä¾‹å¦‚ï¼š`zhangsan`ï¼‰ç”³è¯·è´¦å·ï¼š

### 1. å®¿ä¸»æœºç«¯æ“ä½œ (ç®¡ç†å‘˜)

Bash

```
# 1. åˆ›å»ºå®¹å™¨ initåé¢ç´§è·Ÿçš„æ˜¯æ¨¡æ¿åï¼Œå…¶æ¬¡æ˜¯åˆ›å»ºçš„åå­—
lxc init founding-titan-v2 zhangsan

# 2. åˆ†é…æ˜¾å¡ (å…±äº«æ¨¡å¼)
lxc config device add zhangsan gpu gpu

# 3. æŒ‚è½½å…¬å…±æ•°æ®é›† (å¯é€‰å¯ä¸é€‰ï¼Œçœç©ºé—´)
lxc config device add zhangsan common-data disk source=/home/ubuntu/shared_datasets path=/mnt/datasets readonly=true

# 4. ç«¯å£æ˜ å°„ 
# å‡è®¾å¼ ä¸‰åˆ†é…ç«¯å£ 10001
lxc config device add zhangsan ssh-proxy proxy listen=tcp:0.0.0.0:10001 connect=tcp:127.0.0.1:22

# 5. å¯åŠ¨
lxc start zhangsan
```

### 2. å®¹å™¨ç«¯åˆå§‹åŒ– (ç®¡ç†å‘˜è¿›å…¥å®¹å™¨é…ç½®)

Bash

ä¸‹é¢çš„sudoæƒé™æ˜¯è®©æ¯ä¸ªäººæœ‰åœ¨**è‡ªå·±å®¹å™¨å†…çš„ç®¡ç†å‘˜æƒé™**ï¼Œè€Œéå®¿ä¸»æœºçš„ç®¡ç†å‘˜æƒé™ã€‚

```
lxc exec zhangsan bash
# --- è¿›å…¥å®¹å™¨å ---
useradd -m -s /bin/bash zhangsan  # å»ºè´¦å·
passwd zhangsan                   # è®¾å¯†ç  (å¿…é¡»è¾“ä¸¤é)
usermod -aG sudo zhangsan         # ç»™ sudo æƒé™ 
exit
```

### 3. äº¤ä»˜ç»™å­¦ç”Ÿï¼Œä¸åŒå®¹å™¨çš„sshè®¿é—®é€šè¿‡ç«¯å£å®ç°

> - **IP:** `192.168.137.203`
> - **Port:** `10001`
> - **User:** `zhangsan`
> - **Data:** å…¬å…±æ•°æ®é›†åœ¨ `/mnt/datasets`
> - **Env:** å·²é…ç½®å¥½ Conda/Pip æºï¼Œè¯·ç›´æ¥ `conda create`ã€‚

------





ğŸ‰ ç»“è¯­ï¼š

è¿™å¥—ç³»ç»Ÿç›®å‰å·²ç»å…·å¤‡äº†**â€œç¯å¢ƒéš”ç¦»ã€ç®—åŠ›å…±äº«ã€å¿«é€Ÿéƒ¨ç½²â€**çš„èƒ½åŠ›ã€‚åç»­åªéœ€è¦å®šæœŸåœ¨å®¿ä¸»æœºæ›´æ–°é©±åŠ¨ (apt upgrade)ï¼Œå®¹å™¨å†…éƒ¨å®Œå…¨äº¤ç»™æ¯ä¸ªäººè‡ªç”±æŠ˜è…¾ã€‚