

# 📘 实验室 GPU 服务器管理员手册 (LXD版)

## 1. 新人使用流程 

每当有新同学（例如：王五 `wangwu`）来申请账号时，请按此流程操作：

**第一步：在宿主机 (Host) 创建容器**



**模式1. 从“模板容器”复制新容器。**

初始模板**有**：

​	预装软件： 已经装好的 Vim, Git, Wget 等工具。

​	预设配置： 已经配好的清华源（Conda/Pip/Apt）、已经修好的 SSH 密码登录权限。

​	驱动能力： 已经打通的显卡驱动535，适用于所有<=cuda12.2的项目。预装miniconda，和windows命令一样。

初始模板**没有**：

​	显卡驱动 (NVIDIA Driver)。为什么?LXD 容器共用宿主机的内核和驱动。当你在宿主机配置 `lxc config device add ... gpu` 		时，LXD 会自动把宿主机的驱动库文件映射进容器。

​	PyTorch / TensorFlow / PaddlePaddle

​	CUDA Toolkit / cuDNN (系统级)

```
# 1
lxc init founding-titan wangwu
# 2. 分配所有显卡 
lxc config device add wangwu gpu gpu
	只给特定显卡 (比如只给第 0 张)
lxc config device add <容器名> gpu0 gpu id=0

# 3. 分配 SSH 端口 (不可重复)
# 假设王五是 10003 
lxc config device add wangwu ssh-proxy proxy listen=tcp:0.0.0.0:10003 connect=tcp:127.0.0.1:22

# 4. (可选) 限制资源防止撑爆服务器
lxc config set wangwu limits.memory 64GB
lxc config set wangwu limits.cpu 16

# 5. 启动容器
lxc start wangwu
```

**模式2：创建自己的新容器**，适用于不同于模板的需求

```
# 1
跳转见《部署》文档的创建新容器部分
```

制作完新模板时，可以按照自己的需求配环境。同理自己不想复用就在模板上直接用；想复用就复制自己独特的模板

```

```

**第二步：配置用户与密码**

Bash

```
# 1. 进入容器
lxc exec wangwu bash

# 2. 容器内操作
useradd -m -s /bin/bash wangwu  # 建号
passwd wangwu                   # 设密码 (输两遍)
usermod -aG sudo wangwu         # 给管理员权限
exit                            # 退出
```

**第三步：发送给同学的信息**

> - **IP:** `192.168.137.203` (换成你的实际 IP)
> - **Port:** `10003`
> - **User:** `wangwu`
> - **连接命令:** `ssh wangwu@192.168.137.203 -p 10003`

------

## 2. 日常管理命令 (宿主机端)

**查看所有容器状态** (每天看一眼)

Bash

```
lxc list
```

- *关注 IPV4 是否有值，STATE 是否为 RUNNING。*

**容器的启停**

Bash

```
lxc stop zhangsan      # 强制关机 (同学跑死循环时用)
lxc start zhangsan     # 开机
lxc restart zhangsan   # 重启
lxc delete zhangsan    # 删库跑路 (慎用！删了就找不回了)
```

**查看资源占用 **

管理员显卡分配

```
sudo gm
# 这是最新的管理脚本，可以查看显卡被谁使用，并提供分配剥夺的提示命令。使用它就对了
 
gpu-board
# 这是之前的管理脚本，只能查看显卡总体使用，是谁不知道苏
```



```
# 查看显卡占用
sudo gm
gpu-board  # 用的少

🚀  LABORATORY GPU STATUS BOARD  (Host: gpuserver)
=====================================================================================
ID   Status     GPU Util                  Memory Usage              Active Containers
-------------------------------------------------------------------------------------
[0]  🔴 BUSY     ██████░░░░░░░░░ 41%        █████░░░░░░░░░░ 39%   running: y(9700MB)
      PCI: 0000:01:00.0 | NVIDIA GeForce RTX 3090 | 9706 / 24576 MB
-------------------------------------------------------------------------------------
[1]  🔴 BUSY     ██████░░░░░░░░░ 41%        ██████░░░░░░░░░ 42%   running: yn(10380MB)
      PCI: 0000:81:00.0 | NVIDIA GeForce RTX 3090 | 10386 / 24576 MB
-------------------------------------------------------------------------------------
[2]  🔴 BUSY     ███████░░░░░░░░ 48%        █████░░░░░░░░░░ 38%   running: y(9336MB)
      PCI: 0000:C1:00.0 | NVIDIA GeForce RTX 3090 | 9342 / 24576 MB
-------------------------------------------------------------------------------------

📋 ADMIN COMMAND CHEAT SHEET
=====================================================================================
[操作] 给容器分配显卡 (基于PCI，更稳定)
  👉 给 0 号卡:  lxc config device add <容器名> gpu0 gpu pci=0000:01:00.0
  👉 给 1 号卡:  lxc config device add <容器名> gpu1 gpu pci=0000:81:00.0
  👉 给 2 号卡:  lxc config device add <容器名> gpu2 gpu pci=0000:C1:00.0
-------------------------------------------------------------------------------------
  ❌ 删除显卡:    lxc config device remove <容器名> gpu0 (或 gpu1/gpu2)
=====================================================================================

# 查看宿主机整体负载 (CPU/内存)
htop
```

------

## 3. 文件管理与传输

场景 A：同学想从自己电脑传文件进去 (最常用)

告诉同学在他们自己的 PowerShell 里用 SCP：

PowerShell

```
# 传文件到服务器
scp -P 10001 本地文件.zip zhangsan@192.168.137.203:~/

# 从服务器下载文件
scp -P 10001 zhangsan@192.168.137.203:~/结果.csv ./
```

场景 B：你是管理员，你想直接塞文件给同学

你不需要密码，可以直接用 LXD 塞进去：

Bash

```
# 从宿主机把 data.zip 塞给 zhangsan 的家目录
lxc file push data.zip zhangsan/home/zhangsan/

# 把 zhangsan 的作业拿出来
lxc file pull zhangsan/home/zhangsan/homework.py ./
```

------

## 4. 故障急救

情况 1：容器突然没网了 / 没 IP 了

症状：lxc list 里 IPV4 是空的，或者同学喊连不上。

解决： 重启 LXD 的网络服务。

Bash

```
sudo snap restart lxd
# 等几秒后
lxc restart <容器名>
```

情况 2：显卡突然看不到了

症状：输入 nvidia-smi 报错。

解决： 这通常是因为内核更新了。

Bash

```
sudo reboot
# 重启是解决 90% 硬件问题的良药
```

情况 3：宿主机连不上网了

症状：宿主机 ping baidu.com 不通。

解决： 检查物理网线，或者强制唤醒网卡 (你之前用过的那招)。

Bash

```
sudo ip link set eno1 up
sudo dhclient eno1
```

------

## 5. 维护与更新 (长期)

**宿主机系统更新 (一个月一次)**

Bash

```
sudo apt update && sudo apt upgrade -y
```

- *注意：如果更新了内核 (linux-image)，记得重启服务器。*

备份容器 (快照)

如果张三要做高危操作，先给他拍个快照，坏了能回滚。

Bash

```
# 创建快照
lxc snapshot zhangsan snap01

# 恢复快照 
lxc restore zhangsan snap01
```

------

